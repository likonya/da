
create table events (
	event_datetime TIMESTAMP not null,
	event_name VARCHAR(50) not null,
	user_id INT not null
)

INSERT INTO events (event_datetime, event_name, user_id) VALUES
('2025-02-01 11:20:00', 'APP_OPEN', 1000),
('2025-02-01 10:29:00', 'APP_OPEN', 1001),
('2025-02-01 10:39:00', 'APP_OPEN', 1002),
('2025-02-01 10:40:00', 'APP_OPEN', 1003),
('2025-02-01 10:49:00', 'APP_OPEN', 1004),
('2025-02-01 10:18:00', 'APP_OPEN', 1005),
('2025-02-01 11:10:00', 'APP_OPEN', 1006),
('2025-02-01 11:58:00', 'APP_OPEN', 1007),
('2025-02-01 11:52:00', 'APP_OPEN', 1008),
('2025-02-01 11:14:00', 'APP_OPEN', 1009),
('2025-02-01 10:11:00', 'APP_OPEN', 1010),
('2025-02-01 10:31:00', 'APP_OPEN', 1011),
('2025-02-01 11:13:00', 'APP_OPEN', 1012),
('2025-02-01 11:16:00', 'APP_OPEN', 1013),
('2025-02-01 10:51:00', 'APP_OPEN', 1014),
('2025-02-01 10:28:00', 'APP_OPEN', 1015),
('2025-02-01 11:50:00', 'APP_OPEN', 1016),
('2025-02-01 10:10:00', 'APP_OPEN', 1017),
('2025-02-01 11:40:00', 'APP_OPEN', 1018),
('2025-02-01 10:05:00', 'APP_OPEN', 1019),
('2025-02-01 11:30:00', 'APP_OPEN', 1020),
('2025-02-01 11:34:00', 'APP_OPEN', 1021),
('2025-02-01 10:24:00', 'APP_OPEN', 1022),
('2025-02-01 11:50:00', 'APP_OPEN', 1023),
('2025-02-01 10:57:00', 'APP_OPEN', 1024),
('2025-02-01 10:38:00', 'APP_OPEN', 1025),
('2025-02-01 11:15:00', 'APP_OPEN', 1026),
('2025-02-01 10:54:00', 'APP_OPEN', 1027),
('2025-02-01 11:16:00', 'APP_OPEN', 1028),
('2025-02-01 11:36:00', 'APP_OPEN', 1029),
('2025-02-01 10:18:00', 'APP_OPEN', 1030),
('2025-02-01 10:10:00', 'APP_OPEN', 1031),
('2025-02-01 10:37:00', 'APP_OPEN', 1032),
('2025-02-01 10:12:00', 'APP_OPEN', 1033),
('2025-02-01 12:00:00', 'APP_OPEN', 1034),
('2025-02-01 11:13:00', 'APP_OPEN', 1035),
('2025-02-01 10:39:00', 'APP_OPEN', 1036),
('2025-02-01 10:27:00', 'APP_OPEN', 1037),
('2025-02-01 10:48:00', 'APP_OPEN', 1038),
('2025-02-01 10:37:00', 'APP_OPEN', 1039),
('2025-02-01 11:34:00', 'APP_OPEN', 1040),
('2025-02-01 11:21:00', 'APP_OPEN', 1041),
('2025-02-01 11:46:00', 'APP_OPEN', 1042),
('2025-02-01 10:21:00', 'APP_OPEN', 1043),
('2025-02-01 10:13:00', 'APP_OPEN', 1044),
('2025-02-01 11:29:00', 'APP_OPEN', 1045),
('2025-02-01 11:01:00', 'APP_OPEN', 1046),
('2025-02-01 11:58:00', 'APP_OPEN', 1047),
('2025-02-01 11:35:00', 'APP_OPEN', 1048),
('2025-02-01 11:45:00', 'APP_OPEN', 1049),
('2025-02-01 11:55:00', 'APP_OPEN', 1050),
('2025-02-01 10:31:00', 'APP_OPEN', 1051),
('2025-02-01 11:43:00', 'APP_OPEN', 1052),
('2025-02-01 10:31:00', 'APP_OPEN', 1053),
('2025-02-01 10:36:00', 'APP_OPEN', 1054),
('2025-02-01 10:17:00', 'APP_OPEN', 1055),
('2025-02-01 11:51:00', 'APP_OPEN', 1056),
('2025-02-01 11:44:00', 'APP_OPEN', 1057),
('2025-02-01 11:52:00', 'APP_OPEN', 1058),
('2025-02-01 11:36:00', 'APP_OPEN', 1059),
('2025-02-01 11:21:00', 'CLICK_PRODUCT', 1050),
('2025-02-01 11:03:00', 'CLICK_PRODUCT', 1051),
('2025-02-01 11:47:00', 'CLICK_PRODUCT', 1059),
('2025-02-01 10:57:00', 'CLICK_PRODUCT', 1027),
('2025-02-01 11:24:00', 'CLICK_PRODUCT', 1023),
('2025-02-01 11:49:00', 'CLICK_PRODUCT', 1056),
('2025-02-01 11:21:00', 'CLICK_PRODUCT', 1026),
('2025-02-01 10:33:00', 'CLICK_PRODUCT', 1028),
('2025-02-01 10:44:00', 'CLICK_PRODUCT', 1040),
('2025-02-01 10:34:00', 'CLICK_PRODUCT', 1008),
('2025-02-01 10:27:00', 'CLICK_PRODUCT', 1035),
('2025-02-01 10:33:00', 'CLICK_PRODUCT', 1055),
('2025-02-01 10:13:00', 'CLICK_PRODUCT', 1020),
('2025-02-01 10:44:00', 'CLICK_PRODUCT', 1032),
('2025-02-01 11:29:00', 'CLICK_PRODUCT', 1006),
('2025-02-01 10:35:00', 'CLICK_PRODUCT', 1024),
('2025-02-01 11:12:00', 'CLICK_PRODUCT', 1052),
('2025-02-01 11:06:00', 'CLICK_PRODUCT', 1011),
('2025-02-01 10:27:00', 'CLICK_PRODUCT', 1018),
('2025-02-01 11:14:00', 'CLICK_PRODUCT', 1016),
('2025-02-01 10:36:00', 'CLICK_PRODUCT', 1043),
('2025-02-01 11:46:00', 'CLICK_PRODUCT', 1044),
('2025-02-01 11:16:00', 'CLICK_PRODUCT', 1057),
('2025-02-01 10:42:00', 'CLICK_PRODUCT', 1033),
('2025-02-01 11:35:00', 'CLICK_PRODUCT', 1054),
('2025-02-01 11:05:00', 'CLICK_PRODUCT', 1012),
('2025-02-01 11:13:00', 'CLICK_PRODUCT', 1053),
('2025-02-01 10:48:00', 'CLICK_PRODUCT', 1002),
('2025-02-01 10:08:00', 'CLICK_PRODUCT', 1003),
('2025-02-01 10:30:00', 'CLICK_PRODUCT', 1021),
('2025-02-01 11:30:00', 'CLICK_PRODUCT', 1015),
('2025-02-01 11:02:00', 'CLICK_PRODUCT', 1047),
('2025-02-01 10:30:00', 'CLICK_PRODUCT', 1013),
('2025-02-01 11:36:00', 'CLICK_PRODUCT', 1010),
('2025-02-01 10:27:00', 'CLICK_PRODUCT', 1036),
('2025-02-01 11:03:00', 'CLICK_PRODUCT', 1038),
('2025-02-01 10:45:00', 'CLICK_PRODUCT', 1007),
('2025-02-01 10:18:00', 'CLICK_PRODUCT', 1000),
('2025-02-01 11:36:00', 'CLICK_PRODUCT', 1046),
('2025-02-01 10:52:00', 'CLICK_PRODUCT', 1039),
('2025-02-01 11:54:00', 'PRESS_BUY', 1044),
('2025-02-01 10:34:00', 'PRESS_BUY', 1008),
('2025-02-01 10:24:00', 'PRESS_BUY', 1056),
('2025-02-01 10:05:00', 'PRESS_BUY', 1026),
('2025-02-01 11:01:00', 'PRESS_BUY', 1054),
('2025-02-01 11:21:00', 'PRESS_BUY', 1050),
('2025-02-01 11:21:00', 'PRESS_BUY', 1055),
('2025-02-01 11:43:00', 'PRESS_BUY', 1040),
('2025-02-01 10:18:00', 'PRESS_BUY', 1028),
('2025-02-01 10:14:00', 'PRESS_BUY', 1046),
('2025-02-01 10:39:00', 'SUCCESS_TRANSACTION', 1055),
('2025-02-01 10:32:00', 'SUCCESS_TRANSACTION', 1044),
('2025-02-01 11:34:00', 'SUCCESS_TRANSACTION', 1054),
('2025-02-01 10:53:00', 'SUCCESS_TRANSACTION', 1050),
('2025-02-01 12:00:00', 'SUCCESS_TRANSACTION', 1028),
('2025-02-01 10:53:00', 'SUCCESS_TRANSACTION', 1046);

select * from events


with cte1 as (
	SELECT
    	event_name,
    	COUNT(DISTINCT user_id) as users
	FROM events
	WHERE event_name IN ('APP_OPEN', 'CLICK_PRODUCT', 'PRESS_BUY', 'SUCCESS_TRANSACTION')
	GROUP BY event_name
),
cte2 as (
	select 
		case event_name
  			WHEN 'APP_OPEN' THEN 1
 	    	WHEN 'CLICK_PRODUCT' THEN 2
  			WHEN 'PRESS_BUY' THEN 3
  			WHEN 'SUCCESS_TRANSACTION' THEN 4
	end as step,
	event_name,
	users
	from cte1
)

SELECT
  event_name,
  users,
  ROUND(100.0 * users / LAG(users) OVER (ORDER BY step), 2) AS conversion_from_previous,
  ROUND(100.0 * users / FIRST_VALUE(users) OVER (ORDER BY step), 2) AS conversion_from_first
FROM cte2
ORDER BY step;

